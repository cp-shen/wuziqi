#include "renjuGame.h"

void battle()
{
	struct inst instruction;

	int turn = 0;
	int *turn_p = &turn;
	int win = NONE;

	struct renju *head = (struct renju *)malloc(LEN);
	head->next = NULL;

	while (win == NONE)
	{
		turn++;
		instruction = getInst();

		if (turn % 2 == 1 && instruction.operation== GO)
			play(head, WHITE_PLAYER,turn_p, instruction);
		else if (turn % 2 == 0 && instruction.operation == GO)
			play(head, BLACK_PLAYER,turn_p, instruction);

		draw(head);
		
		win = isWin(head);
	}

	while (head->next->next != NULL)
		head = head->next;

	head->next = NULL;
	//删除尾部空节点

}

void play(struct renju *head,int player, int *turn_p,struct inst instruction)
{
	int i = instruction.x;
	int j = instruction.y;
		
	while (head->next != NULL)
	{
		if (head->x == i&&head->y == j)
		{
			(*turn_p)--;
			return;//此时该处已经有棋子
		}
		head = head->next;
	}

	if (head->x == i&&head->y == j)
	{
		(*turn_p)--;
		return;//此时该处已经有棋子(最后一个节点)
	}

	head->x = i;
	head->y = j;
	head->player = player;
	head->turn = *turn_p;

	head->next = (struct renju *)malloc(LEN);
	//申请新节点
	head = head->next;
	head->next = NULL;
}

void draw(struct renju*head)
{
	while (head->next->next != NULL)
		//尾部为空节点，故最后一个棋子在倒数第二个节点
		head = head->next;

	if (head->player == WHITE_PLAYER)
		setfillcolor(WHITE);
	else
		setfillcolor(BLACK);

	solidcircle(99 + 33 * head->x , 99 + 33 * head->y ,12);
}

struct renju *search(struct renju *head ,int x,int y)
{
	do
	{
		if (head->x == x && head->y == y)
			return head;

		else head = head->next;
	} while (head!=NULL);

	return NULL;
	//没找到该节点
}
int isWin(struct renju *head)
{
	struct renju *last = head;
	while (last->next->next != NULL)
		last = last->next;
	//找到最后一个落子的节点

	int i, j;//循环变量
	int x, y;
	x = last->x;
	y = last->y;

	//自左向右检查
	i = x-4;
	j = y;
	for (i = x-4; i <= x; i++)
	{
		if (search(head, i, j) != NULL && search(head, i, j)->player == last->player
			&& search(head, i + 1, j) != NULL && search(head, i + 1, j)->player == last->player
			&& search(head, i + 2, j) != NULL && search(head, i + 2, j)->player == last->player
			&& search(head, i + 3, j) != NULL && search(head, i + 3, j)->player == last->player
			&& search(head, i + 4, j) != NULL && search(head, i + 4, j)->player == last->player)

			return last->player;
	}

	//自上向下检查
	i = x;
	j = y-4;
	for (j = y-4; j <= y; j++)
	{
		if (search(head, i, j) != NULL && search(head, i, j)->player == last->player
			&& search(head, i, j + 1) != NULL && search(head, i, j + 1)->player == last->player
			&& search(head, i, j + 2) != NULL && search(head, i, j + 2)->player == last->player
			&& search(head, i, j + 3) != NULL && search(head, i, j + 3)->player == last->player
			&& search(head, i, j + 4) != NULL && search(head, i, j + 4)->player == last->player)

			return last->player;

	}

	//自左上向右下检查
	i = x-4;
	j = y-4;

	while (!(i == x+1 && j == y+1))
	{
		if (search(head, i, j) != NULL && search(head, i, j)->player == last->player
			&&search(head, i + 1, j + 1) != NULL && search(head, i + 1, j + 1)->player == last->player
			&&search(head, i + 2, j + 2) != NULL && search(head, i + 2, j + 2)->player == last->player
			&&search(head, i + 3, j + 3) != NULL && search(head, i + 3, j + 3)->player == last->player
			&&search(head, i + 4, j + 4) != NULL && search(head, i + 4, j + 4)->player == last->player)

			return last->player;

		else
		{
			i++;
			j++;
		}
	}

	//自右上向坐下检查
	i = x+4;
	j = y-4;

	while (!(i == x-1 && j == y+1))
	{
		if (  search(head, i, j) != NULL && search(head, i, j)->player == last->player
			&&search(head, i - 1, j + 1) != NULL && search(head, i - 1, j + 1)->player == last->player
			&&search(head, i - 2, j + 2) != NULL && search(head, i - 2, j + 2)->player == last->player
			&&search(head, i - 3, j + 3) != NULL && search(head, i - 3, j + 3)->player == last->player
			&&search(head, i - 4, j + 4) != NULL && search(head, i - 4, j + 4)->player == last->player)

			return last->player;

		else
		{
			i--;
			j++;
		}
	}

	//检查是否平局
	if (last->turn == 225)
		return TIE;


	return NONE;
}

void regret(struct renju *head, int *turn_p)
{
}



